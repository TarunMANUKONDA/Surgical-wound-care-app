const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const imageUrl = reader.result as string;
        setUploadedImageUrl(imageUrl);
        setShowUploadModal(true);
        setAnalysisComplete(false);
        
        try {
          // Analyze the new image
          const analysis = await analyzeImage(imageUrl);
          
          // Compare with most recent scan if available
          let comparison = null;
          if (sortedHistory.length > 0) {
            comparison = compareWithPrevious(analysis);
          }
          
          setComparisonData(comparison);
          setAnalysisComplete(true);
          
          // Define patient answers
          const answers = {
            daysSinceSurgery: 0,
            painLevel: 'none' as const,
            dischargeType: 'no' as const,
            hasFever: false,
            rednessSpread: false,
            dressingChanged: true,
          };
          
          // Save directly to history (this persists to localStorage immediately)
          addWoundToHistory(imageUrl, analysis, answers, comparison);
          
          // Also notify the parent component for backward compatibility
          const newScan: WoundImage = {
            id: Date.now().toString(),
            url: imageUrl,
            date: new Date(),
            status: analysis.riskLevel as any,
            healingStage: analysis.healingStage,
            analysis: analysis,
          };
          
          onAddNewScan(newScan);
        } catch (error) {
          console.error('Error analyzing image:', error);
          setAnalysisComplete(true);
        }
      };
      reader.readAsDataURL(file);
    }
  };
